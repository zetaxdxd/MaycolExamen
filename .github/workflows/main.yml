name: ğŸš€ CI/CD con SonarQube y Docker

on:
  push:
    branches:
      - main

jobs:
  build-analyze-deploy:
    name: ğŸ” Build + AnÃ¡lisis + Despliegue
    runs-on: self-hosted

    steps:
      - name: ğŸ“¥ Paso 1 - Clonar repositorio
        uses: actions/checkout@v3

      - name: â˜• Paso 2 - Instalar Java y Maven
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: ğŸ§ª Paso 3 - Compilar con Maven
        run: |
          echo "ğŸ“¦ Compilando proyecto..."
          mvn clean package -DskipTests
          echo "âœ… Build completado."

      - name: ğŸ“Š Paso 4 - AnÃ¡lisis con SonarQube
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          echo "ğŸ” Ejecutando anÃ¡lisis SonarQube..."
          mvn sonar:sonar \
            -Dsonar.projectKey=lpapp \
            -Dsonar.projectName=lpapp \
            -Dsonar.host.url=http://localhost:9000 \
            -Dsonar.login=$SONAR_TOKEN
          echo "âœ… AnÃ¡lisis completado."

      - name: ğŸ³ Paso 5 - Desplegar con Docker Compose
        run: |
          echo "ğŸ§¹ Apagando contenedores anteriores si existen..."
          docker compose -f docker/docker-compose.yml down -v --remove-orphans || echo "âš  No se pudo bajar contenedores"

          echo "ğŸš€ Iniciando nuevo despliegue..."
          docker compose -f docker/docker-compose.yml up -d --build || echo "âŒ Error en docker-compose up"

          echo "â³ Esperando 10 segundos..."
          sleep 10

          echo "ğŸ“‹ Contenedores activos:"
          docker ps

          echo "ğŸ“ Logs recientes del contenedor product_app_2025:"
          docker logs --tail=50 product_app_2025 || echo "âš  No se pudo obtener logs"
